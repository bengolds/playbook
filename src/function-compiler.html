<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="mathObjects/math-objects-import.html">
<script src="../libs/algebrite/dist/algebrite.bundle-for-browser.js"></script>
<script src="../bower_components/mathjs/dist/math.js"></script>

<dom-module id="function-compiler">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    
  </template>
  <script>
    Polymer({
      is: 'function-compiler',
      properties: {
        definition: {
          type: Object,
          notify: false,
          observer: 'recompile'
        },
        scope: {
          type: Object,
          notify: false,
          value: function() {return new Scope();},
          observer: 'recompile'
        },
        compiled: {
          type: Object,
          readOnly: true,
          notify: true,
        }
      },

      observers: [
      ],

      attached: function() {

      },

      recompile: function() {
        try {
          if (!this.definition || this.definition == '') {
            throw Error('No function to compile');
          }
          let simplified = Algebrite.simplify(this.definition).toString();
          let parsed = math.parse(simplified);
          let symbols = this.getSymbols(parsed);

          let compiled = new CompiledFunction(parsed.compile(), symbols, this.scope);
          this.updateScope(compiled);
          this._setCompiled(compiled);
          this.fire('compile-ok');
        }
        catch(e) {
          this.fire('compile-error', e);
        }
      },

      updateScope: function (funcToLoad) {
        //TODO: ALSO GET RID OF OLD VARIABLES IF NO LONGER USED
        for (let variable of funcToLoad.variables) {
          if (!this.scope.hasVariable(variable.name)) {
            this.push('scope.variables', variable);
          }
        }
      },

      getSymbols: function(parsedFunction) {
        var symbols = [];
        parsedFunction.traverse( (node) => {
          if (node.type == 'SymbolNode' && !symbols.includes(node.name)) {
            let variable = new Variable(node.name);
            if (this.scope.hasVariable(node.name)) {
              variable = this.scope.getVariable(node.name);
            }
            symbols.push(variable);
          }
        });
        return symbols;
      },

    });
  </script>
</dom-module>