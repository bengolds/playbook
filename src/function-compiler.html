<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="mathObjects/math-objects-import.html">
<script src="../libs/algebrite/dist/algebrite.bundle-for-browser.js"></script>
<script src="../bower_components/mathjs/dist/math.js"></script>

<dom-module id="function-compiler">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    
  </template>
  <script>
    Polymer({
      is: 'function-compiler',
      properties: {
        definition: {
          type: Object,
          notify: false,
          observer: 'recompile'
        },
        scope: {
          type: Object,
          notify: false,
          value: function() {return new Scope();},
          observer: 'recompile'
        },
        compiled: {
          type: Object,
          readOnly: true,
          notify: true,
        }
      },

      observers: [
      ],

      attached: function() {

      },

      recompile: function() {
        try {
          if (!this.definition || this.definition == '') {
            throw Error('No function to compile');
          }
          let simplified = Algebrite.simplify(this.definition).toString();
          let processed = this.insertMultipliers(simplified);
          let parsed = math.parse(processed);
          let symbols = this.getVariables(parsed);

          let compiled = new CompiledFunction(parsed.compile(), symbols, this.scope);
          this.updateScope(compiled);
          this._setCompiled(compiled);
          this.fire('compile-ok');
        }
        catch(e) {
          this.fire('compile-error', e);
        }
      },

      updateScope: function (funcToLoad) {
        for (let variable of funcToLoad.variables) {
          if (!this.scope.hasVariable(variable.name)) {
            this.push('scope.variables', variable);
          }
        }
      },

      getVariables: function(parsedFunction) {
        var symbols = [];
        parsedFunction.traverse( (node) => {
          if (node.type == 'SymbolNode' && !symbols.includes(node.name)) {
            symbols.push(node.name);
          }
        });

        let variables = symbols.map( (symbol) => {
          if (this.scope.hasVariable(symbol)) {
            return this.scope.getVariable(symbol);
          }
          else {
            return new Variable(symbol);
          }
        });

        return variables;
      },

      insertMultipliers: function(input) {
        let re = /([a-z]+)\s*\(/g;
        return input.replace(re, (match, symbol) => {
          if (symbol.length > 1 || this.scope.isFunction(symbol)){
            return match;
          } else {
            return symbol+'*(';
          }
        });
      }

    });
  </script>
</dom-module>