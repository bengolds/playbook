<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="mathbox-plot.html">
<link rel="import" href="function-input.html">
<link rel="import" href="function-signature.html">
<link rel="import" href="function-compiler.html">

<dom-module id="function-row">
  <template>
  <style include="shared-styles"></style>
    <style>
      #container {
        position: relative;
        display: flex;
        flex-wrap: nowrap;
        align-items: center;
        height: 192px;
        max-width: 1280px;
        margin-top: 8px;
        margin-left: auto;
        margin-right: auto;
      }
      #signature {
        margin-left: 24px;
      }
      #plot {
        max-width: 480px;
        height: 100%;
      }
    </style>
    <paper-card id='container'>
      <div class='topLeftTray'>
        <paper-icon-button id='closeButton' icon="close" on-tap='removeRow'></paper-icon-button>
        <paper-icon-button icon="speaker-notes"></paper-icon-button>
      </div>

      <function-signature id='signature'
        name='{{functionDefinition.name}}'
        parameters='{{compiled.freeVariables}}'
        scope='{{scope}}'
        ></function-signature>
      <function-input id='input'
        definition='{{functionDefinition.parseableString}}'
        latex='{{functionDefinition.latex}}'
        ></function-input>
      <function-compiler id='compiler'
        definition='{{functionDefinition.parseableString}}'
        scope='{{scope}}'
        compiled='{{compiled}}'
        ></function-compiler>
      <mathbox-plot id='plot' animated
        compiled-function='{{compiled}}'
        synced-parameters='{{graphParameters}}'
        ></mathbox-plot>
    </paper-card>
  </template>

  <script>
    Polymer({
      is: 'function-row',
      properties: {
        functionDefinition: {
          type: Object,
          notify: true,
          value: function() {return new FunctionDefinition();},
        },
        graphParameters: {
          type: Object,
          notify: true,
          value: function() {return {};},
        },
        scope: {
          type: Object,
          notify: true,
          value: function() {return new Scope();},
        },
        compiled: {
          type: Object,
          notify: false,
          observer: 'compiledChanged'
        }
      },

      listeners: {
        // 'input-ok': 'inputOk',
        // 'input-error': 'inputError',
      },

      removeRow: function() {
        this.fire('remove-row', this.functionDefinition.name);
      },

      compiledChanged: function() {
        // if (this.oldCompiled) {
        //   for (let freeVar of this.oldCompiled.freeVariables) {
        //     let indexOfVar = this.scope.indexOfFreeVar;
        //     if (indexOfVar = -1) {
        //       this.splice('scope.freeVariables', indexOfVar, 1);
        //     }
        //   }
        // }

        for (let freeVar of this.compiled.freeVariables) {
          if (!this.scope.isVariableInScope(freeVar.name)) {
            this.push('scope.freeVariables', freeVar);
          }
        }

        this.oldCompiled = this.compiled;
      },

      nameChanged: function () {
        // body...
      }

    });
 </script>
</dom-module>