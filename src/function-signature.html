<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="mathquill-element.html">
<link rel="import" href="var-action-bar.html">
<script src="variable.js"></script>
<script src="../bower_components/mathjs/dist/math.js"></script>

<dom-module id="function-signature">
  <template>
    <style>
      :host {
        display: block;
        white-space: nowrap;
      }
      mathquill-element {
        font-size: 200%;
      }
      #nameQuill {
        margin-right: -10px;
      }
      .hidden {
        display:none;
      }
    </style>

  <mathquill-element id="nameQuill"
    on-element-mouseover='onNameMouseOver' 
    on-mouseleave='onNameMouseLeave'
    on-edit='onNameEdit'
    on-enter='onNameExit'
    editable='[[editing]]'>
  </mathquill-element>
  <mathquill-element id="parametersQuill"
    on-element-mouseover='onParameterMouseOver'>
  </mathquill-element>
  <var-action-bar id="actionbar" class="hidden" functor='{{functor}}'></var-action-bar>

  </template>
  <script>
    Polymer({
      is: 'function-signature',
      properties: {
        name: {
          type: String,
          notify: true,
          observer: 'nameChanged'
        },
        parameters: {
          type: Array,
          value: function() {return [];},
          observer: 'updateSignature'
        },
        pinnedVariables: {
          type: Array,
          value: function() {return [];},
          observer: 'updateSignature'
        },
        editing: {
          type: Boolean,
          value: false,
          readOnly: true,
          observer: 'editingChanged'
        }
      },

      observers: [
        'updateSignature(parameters.splices)',
        'updateSignature(pinnedVariables.splices)'
      ],

      attached: function () {
        this.initialized = true;
        this.updateSignature();
        this.$.nameQuill.latex(this.name);
      },
      
      updateSignature: function () {
        if (!this.initialized)
          return;

        let latex = '\\left(';
        if (this.parameters) {
          let sorted = this.parameters.slice().sort();

          let isNotPinned = (val) => {
            return !this.pinnedVariables.some((pinned) => {
              return pinned.variable.name === val;
            });
          };

          let filtered = sorted.filter(isNotPinned);
          latex += filtered.join(',');
        }
        latex += '\\right)=';
        this.$.parametersQuill.latex(latex);
      },

      nameChanged: function (_) {
        this.$.nameQuill.latex(this.name);
      },

      editingChanged: function (_) {
        if (this.editing) {
          this.oldName = this.name;
          this.listen(this.$.nameQuill, 'blur', 'onNameExit');
        }
      },

      onParameterMouseOver: function (e, details) {
        if (details.target.tagName == 'VAR') {
          this.showHoverBar(details.target);
          $(this).on('mouseout', this.hideHoverBar);
        }
      },

      onNameMouseOver: function (e, details) {
        if (!this.editing) {
          this.editing = true;
        }
      },

      onNameMouseLeave: function (_) {
        let mq = this.$.nameQuill.getMathQuill();
        //TODO: EXPOSE THIS BLURRED PROP BETTER
        if (mq.__controller.blurred) {
          this.onNameExit();
        }
      },

      onNameEdit: function (e, details) {
        if (details.mathField.latex() != '')  {
          this.name = details.mathField.latex();
        }
      },

      onNameExit: function (_) {
        if (this.$.nameQuill.latex() == '') {
          this.name = this.oldName;
          this.$.nameQuill.latex(this.name);
        }
        this.editing = false;
      },

      showHoverBar: function (target) {
        let actionbar = this.$.actionbar;
        actionbar.classList.remove('hidden');
        let pushDown = 10;
        let topY = target.offsetTop-this.$.actionbar.offsetHeight + pushDown;
        let middleX = target.offsetLeft + target.offsetWidth/2 - actionbar.offsetWidth/2;
        actionbar.style.left = middleX + 'px';
        actionbar.style.top = topY + 'px';
        actionbar.variable = target.textContent;
      },

      hideHoverBar: function() {
        this.$.actionbar.classList.add('hidden');
        $(this).off('mouseout', this.hideHoverBar);
      }

    });
  </script>
</dom-module>