<link rel="import" href="mathquill-element.html">
<link rel="import" href="var-action-bar.html">

<dom-module id="function-signature">
  <template>
    <style>
      :host {
        display: block;
      }
      #quill {
        font-size: 200%;
      }
      .hidden {
        display:none;
      }
    </style>

  <mathquill-element id="quill"
    on-element-mouseover='onElementMouseOver'
    on-click='onClick'>
  </mathquill-element>
  <var-action-bar id="actionbar" class="hidden" functor='{{functor}}'></var-action-bar>

  </template>
  <script>
    Polymer({
      is: 'function-signature',
      properties: {
        functor: {
          type: Object,
          observer: '_functorChanged',
          notify: true
        },
        symbol: {
          type: String,
          value: 'ÆŸ',
          notify: true
        },
        editing: {
          type: Boolean,
          observer: '_updateSignature',
          value: false
        }
      },

      attached: function () {
        this._updateSignature();
      },
      
      _functorChanged: function () {
        this._updateSignature();
      },

      onClick: function(e) {
        if (!this.editing) {
          let clickedNode = e.path[0];
          this.editing = true;
          this.oldSymbol = this.symbol;
          let nameField = this.$.quill.getMathQuill().innerFields[0];
          nameField.focus();
          nameField.config({
            handlers: {
              edit: this.onNameEdit.bind(this),
              enter: this.onNameExit.bind(this)
            }
          });
          this.listen(this.$.quill, 'blur', 'onNameExit');
        }
      },

      onNameEdit: function (mathField) {
        this.symbol = mathField.latex();
      },

      onNameExit: function (mathField) {
        if (this.symbol == '') {
          this.symbol = this.oldSymbol;
        }
        this.editing = false;
      },

      _updateSignature: function () {
        let latex = '';
        if (this.editing) {
          latex = '\\MathQuillMathField{' + this.symbol + '}\\left(';
        } else {
          latex = this.symbol + '\\left(';
        }
        if (this.functor) {
          let sorted = this.functor.symbols.slice().sort();
          latex += sorted.join(',');
        }
        latex += '\\right)=';
        this.$.quill.latex(latex);
      },

      onElementMouseOver: function (e, details) {
        //TODO: When hovering over the function name, change
        //to an input box
        
        // this.$.quill.editable = true;
        var mqCmdId = 'mathquill-command-id';
        var mqBlockId = 'mathquill-block-id';
        if (details.target.tagName == 'VAR' &&
            details.target.textContent != this.symbol) {
          this.showHoverBar(details.target);
          $(this).on('mouseout', this.hideHoverBar);
        }
      },

      showHoverBar: function (target) {
        let actionbar = this.$.actionbar;
        actionbar.classList.remove('hidden');
        let pushDown = 10;
        let topY = target.offsetTop+target.offsetHeight-pushDown;
        let middleX = target.offsetLeft + target.offsetWidth/2 - actionbar.offsetWidth/2;
        actionbar.style.left = middleX + 'px';
        actionbar.style.bottom = topY + 'px';
        actionbar.variable = target.textContent;
      },

      hideHoverBar: function() {
        this.$.actionbar.classList.add('hidden');
        $(this).off('mouseout', this.hideHoverBar);
      }

    });
  </script>
</dom-module>