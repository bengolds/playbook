<link rel="import" href="mathquill-element.html">
<link rel="import" href="var-action-bar.html">

<dom-module id="function-signature">
  <template>
    <style>
      :host {
        display: block;
      }
      mathquill-element {
        font-size: 200%;
      }
      #nameQuill {
        margin-right: -10px;
      }
      .hidden {
        display:none;
      }
    </style>

  <mathquill-element id="nameQuill"
    on-element-mouseover='onNameMouseOver' 
    on-m  ouseleave='onNameMouseLeave'
    on-edit='onNameEdit'
    on-enter='onNameExit'
    editable='[[editing]]'>
  </mathquill-element>
  <mathquill-element id="parametersQuill"
    on-element-mouseover='onParameterMouseOver'>
  </mathquill-element>
  <var-action-bar id="actionbar" class="hidden" functor='{{functor}}'></var-action-bar>

  </template>
  <script>
    Polymer({
      is: 'function-signature',
      properties: {
        functor: {
          type: Object,
          observer: '_functorChanged',
          notify: true
        },
        symbol: {
          type: String,
          value: 'ÆŸ',
          notify: true
        },
        editing: {
          type: Boolean,
          value: false
        }
      },

      attached: function () {
        this._updateSignature();
        this.$.nameQuill.latex(this.symbol);
      },
      
      _functorChanged: function () {
        this._updateSignature();
      },

      _updateSignature: function () {
        let latex = '\\left(';
        if (this.functor) {
          let sorted = this.functor.symbols.slice().sort();
          latex += sorted.join(',');
        }
        latex += '\\right)=';
        this.$.parametersQuill.latex(latex);
      },

      onParameterMouseOver: function (e, details) {
        if (details.target.tagName == 'VAR') {
          this.showHoverBar(details.target);
          $(this).on('mouseout', this.hideHoverBar);
        }
      },

      onNameMouseOver: function (e, details) {
        if (!this.editing) {
          this.editing = true;
          this.oldSymbol = this.symbol;
          this.listen(this.$.nameQuill, 'blur', 'onNameExit');
        }
      },

      onNameMouseLeave: function (_) {
        let mq = this.$.nameQuill.getMathQuill();
        //TODO: EXPOSE THIS BLURRED PROP BETTER
        if (mq.__controller.blurred) {
          this.onNameExit();
        }
      },

      onNameEdit: function (e, details) {
        this.symbol = details.mathField.latex();
      },

      onNameExit: function (_) {
        if (this.symbol == '') {
          this.symbol = this.oldSymbol;
        }
        this.editing = false;
      },

      showHoverBar: function (target) {
        let actionbar = this.$.actionbar;
        actionbar.classList.remove('hidden');
        let pushDown = 10;
        let topY = target.offsetTop-this.$.actionbar.offsetHeight + pushDown;
        let middleX = target.offsetLeft + target.offsetWidth/2 - actionbar.offsetWidth/2;
        actionbar.style.left = middleX + 'px';
        actionbar.style.top = topY + 'px';
        actionbar.variable = target.textContent;
      },

      hideHoverBar: function() {
        this.$.actionbar.classList.add('hidden');
        $(this).off('mouseout', this.hideHoverBar);
      }

    });
  </script>
</dom-module>