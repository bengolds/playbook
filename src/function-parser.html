<script src="../bower_components/mathjs/dist/math.js"></script>
<script src="../bower_components/algebrite/dist/algebrite.bundle-for-browser.js"></script>

<dom-module id="function-parser">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
    
  </template>
  <script>
    Polymer({
      is: 'function-parser',
      getFunctor: function(inputString) {
        var parsedFunction = this._parseFunction(inputString);
        return this._wrapAsFunctor(parsedFunction);
      },
      isParseable: function(inputString) {
        try {
          var parsed = this._parseFunction(inputString);
          console.log('successfully parsed function: ' + inputString);
          return true;
        }
        catch(error) {
          console.log('couldnt parse function: ' + inputString);
          console.log(error);
          return false;
        }
      },

      _parseFunction: function(funcString) {
        var simplified = Algebrite.simplify(funcString).toString();
        var parsed = math.parse(simplified);
        return parsed;
      },
      _getSymbols: function(parsedFunction) {
        var symbols = [];
        parsedFunction.traverse(function (node) {
          if (node.type == 'SymbolNode' && !symbols.includes(node.name)) {
            symbols.push(node.name);
          }
        });
        return symbols;
      },
      _wrapAsFunctor: function(parsedFunction) {
        var symbols = this._getSymbols(parsedFunction);
        var compiled = parsedFunction.compile();
        var functor = {
          symbols: symbols,
          boundVars: {},
          boundRanges: {},
          unboundVars: symbols.slice(0)
        };

        functor.eval = (x) => {
          var scope = {};
          if (functor.unboundVars.length == 1) {
            scope[functor.unboundVars[0]] = x;
          } 
          else if (functor.unboundVars.length > 1) {
            return 0;
          }

          Object.assign(scope, functor.boundVars);
          return compiled.eval(scope);
        };

        functor.bindVar = (symbol, val) => {
          if (functor.symbols.includes(symbol)) {
            functor.boundVars[symbol] = val;

            var index = functor.unboundVars.indexOf(symbol);
            if (index > -1) {
              functor.unboundVars.splice(index, 1);
            }
          }
          else {
            throw symbol + ' was not found in the function.';
          }
        };

        functor.bindRange = (symbol, range) => {
          if (functor.symbols.includes(symbol)) {
            functor.boundRanges[symbol] = range;
          }
          else {
            throw symbol + ' was not found in the function.';
          }
        };

        functor.unbindVar = (symbol, val) => {
          if (functor.symbols.includes(symbol)) {
            delete functor.boundVars[symbol];
            delete functor.boundRanges[symbol];

            if (!functor.unboundVars.includes(symbol)) {
              functor.unboundVars.push(symbol);
            }
          } 
          else {
            throw symbol + 'was not found in the function.';
          }
        };

        return functor;
      },
    });
  </script>
</dom-module>