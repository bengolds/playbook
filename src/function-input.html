<link rel="import" href="mathquill/mathquill-import.html">
<link rel="import" href="hover-plot.html">
<link rel="import" href="function-parser.html">
<dom-module id="function-input">
	<link rel="import" type="css" href="mathquill/mathquill.css"/>
	<template>
		<style>
			:host {
				flex-grow: 1;
			}
			#quill {
				font-size:200%;
			}
      .hidden {
        display:none;
      }
		</style>
	<mathquill-element id="quill" editable="true" 
   on-edit = 'onEdit'
   on-element-mouseover='onElementMouseOver'
   on-element-mouseout= 'onElementMouseOut'>
  </mathquill-element>
  <function-parser id='parser'></function-parser>
  <hover-plot class='hidden' id='hoverplot'></hover-plot>

</template>
<script>
  Polymer({
    is: 'function-input',

    properties: {
      functor: {
        type: Object,
        notify: true
      }
    },

    ready: function() {
      this.scopeSubtree(this.$.quill, true);
      this.functor = this.$.parser.getFunctor('0');
    },

    onEdit: function() {
      var parser = this.$.parser;
      //TODO: put in try/catch block
      var functionString = this.$.quill.semanticText();
      if (parser.isParseable(functionString)) {
        this.functor = parser.getFunctor(functionString);
      }
    },

    onElementMouseOver: function(e, details) {
      var mqCmdId = 'mathquill-command-id';
      var mqBlockId = 'mathquill-block-id';
      var getClosestApplicationNode = (semanticNode) => {
        if (semanticNode instanceof ApplicationNode) {
          return semanticNode;
        } else if (semanticNode == null) {
          return null;
        }
        return getClosestApplicationNode(semanticNode.parent);
      };
      var jqTarget = $(details.target);
      var id = -1;
      if (jqTarget.attr(mqBlockId)) {
        id = jqTarget.attr(mqBlockId);
      } else if (jqTarget.attr(mqCmdId)) {
        id = jqTarget.attr(mqCmdId);
      } else {
        return;
      }
      var semanticTree = details.mathField.semanticTree();
      var semanticNode = semanticTree.findDisplayNode(id);
      var applicationNode = getClosestApplicationNode(semanticNode);
      this.hoveredDisplayNodes = applicationNode.getDisplayNodes();
      for (var i = 0; i < this.hoveredDisplayNodes.length; i++) {
        this.hoveredDisplayNodes[i].jQ.addClass('selected');
      }
      this.$.hoverplot.func = this.$.parser.getFunctor(applicationNode.toString());
      console.log(applicationNode.toString());
      this.$.hoverplot.classList.remove('hidden');
    },
    onElementMouseOut: function(e, details) {
      if (this.hoveredDisplayNodes != null) {
        for (var i = 0; i < this.hoveredDisplayNodes.length; i++) {
          this.hoveredDisplayNodes[i].jQ.removeClass('selected');
        }
      }
      this.$.hoverplot.classList.add('hidden');
    },
    createHoverPlot: function(x, y, funcString) {
      // body...
    }
  });
</script>
</dom-module>